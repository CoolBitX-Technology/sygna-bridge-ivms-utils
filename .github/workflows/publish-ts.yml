  name: Publish Typescript package
  on:
    push:
      branches:
        - master
      paths:
        - typescript/*
        - bridge_and_ivms.json
        - .github/workflows/publish-ts.yml

  defaults:
    run:
      working-directory: typescript

  jobs:
    publish-ts:
      runs-on: ubuntu-latest
      permissions:
        contents: read
        id-token: write
      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Download OpenAPI codegen jar
          run: |
            wget https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/5.0.0-beta/openapi-generator-cli-5.0.0-beta.jar -O ../gen.jar
        
        - name: Generate Typescript legacy code
          run: |
            mkdir -p ./src/generated/legacy
            java -jar ../gen.jar \
              generate -i ../bridge_and_ivms.json \
              -g typescript-fetch \
              -t ./template \
              -o ../tmp
            mv ../tmp/models/* ./src/generated/legacy/
            rm -rf ../tmp
        - name: Generate Typescript ivms2023 code
          run: |
            mkdir -p ./src/generated/ivms2023
            java -jar ../gen.jar \
              generate -i ../bridge_and_ivms2023.json \
              -g typescript-fetch \
              -t ./template \
              -o ../tmp
            mv ../tmp/models/* ./src/generated/ivms2023/
            rm -rf ../tmp
        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
            node-version: '20'
            # ❌ 不加 registry-url

        - name: Install dependencies
          run: npm ci

        # ✅【最終奧義】手動產生 .npmrc (解決死結)
        # 1. 指定 @sygna 走公有庫
        # 2. 設定一個空的 authToken，騙過 ENEEDAUTH 檢查，讓 OIDC 有機會啟動
        - name: Create Project .npmrc
          run: |
            echo "@sygna:registry=https://registry.npmjs.org/" > .npmrc
            echo "//registry.npmjs.org/:_authToken=" >> .npmrc
            cat .npmrc # 印出來確認

        - name: Publish to npm
          run: npm publish --provenance --access public --verbose