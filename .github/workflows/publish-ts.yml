  name: Publish Typescript package
  on:
    push:
      branches:
        - master
      paths:
        - typescript/*
        - bridge_and_ivms.json
        - .github/workflows/publish-ts.yml

  defaults:
    run:
      working-directory: typescript

  jobs:
    publish-ts:
      runs-on: ubuntu-latest
      permissions:
        contents: read
        id-token: write
      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Download OpenAPI codegen jar
          run: |
            wget https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/5.0.0-beta/openapi-generator-cli-5.0.0-beta.jar -O ../gen.jar
        
        - name: Generate Typescript legacy code
          run: |
            mkdir -p ./src/generated/legacy
            java -jar ../gen.jar \
              generate -i ../bridge_and_ivms.json \
              -g typescript-fetch \
              -t ./template \
              -o ../tmp
            mv ../tmp/models/* ./src/generated/legacy/
            rm -rf ../tmp
        - name: Generate Typescript ivms2023 code
          run: |
            mkdir -p ./src/generated/ivms2023
            java -jar ../gen.jar \
              generate -i ../bridge_and_ivms2023.json \
              -g typescript-fetch \
              -t ./template \
              -o ../tmp
            mv ../tmp/models/* ./src/generated/ivms2023/
            rm -rf ../tmp
        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
            node-version: '20'

        - name: Install dependencies
          run: npm ci

        # âœ…ã€æ­¥é©Ÿ Aã€‘æ‰‹å‹•å»ºç«‹ç´”æ·¨çš„ .npmrc
        - name: Create Clean .npmrc
          run: |
            echo "registry=https://registry.npmjs.org/" > .npmrc
            echo "@sygna:registry=https://registry.npmjs.org/" >> .npmrc
            echo "//registry.npmjs.org/:_authToken=" >> .npmrc # ç¢ºä¿æ²’æœ‰æ®˜ç•™ Token
            echo "âœ… .npmrc created."

        # ğŸ”ã€DEBUG 1ã€‘æª¢æŸ¥æª”æ¡ˆèˆ‡ç’°å¢ƒ
        - name: ğŸ” Debug - Inspect Environment
          run: |
            echo "=== 1. Current Directory ==="
            pwd
            ls -la
            
            echo "=== 2. Content of .npmrc ==="
            cat .npmrc
            
            echo "=== 3. NPM Config List (Check registry resolution) ==="
            npm config list
            
            echo "=== 4. Check OIDC Environment Variables ==="
            # æª¢æŸ¥ GitHub æ˜¯å¦æœ‰æ³¨å…¥ OIDC è®Šæ•¸ (ä¸å°å‡ºå€¼ï¼Œåªæª¢æŸ¥å­˜ä¸å­˜åœ¨)
            if [ -z "$ACTIONS_ID_TOKEN_REQUEST_URL" ]; then echo "âŒ OIDC URL: MISSING (Permissions issue?)"; else echo "âœ… OIDC URL: PRESENT"; fi
            if [ -z "$ACTIONS_ID_TOKEN_REQUEST_TOKEN" ]; then echo "âŒ OIDC TOKEN: MISSING"; else echo "âœ… OIDC TOKEN: PRESENT"; fi

        # ğŸ”ã€DEBUG 2ã€‘å˜—è©¦èº«åˆ†é©—è­‰ (é æœŸæœƒå¤±æ•—ï¼Œä½†çœ‹å¤±æ•—è¨Šæ¯å¾ˆé‡è¦)
        - name: ğŸ” Debug - Pre-flight Auth Check
          continue-on-error: true # å…è¨±å¤±æ•—ï¼Œä¸è¦ä¸­æ–·æµç¨‹
          run: |
            echo "Testing 'npm whoami'..."
            echo "Note: In OIDC mode, this might fail because we don't have a static token yet."
            npm whoami --registry https://registry.npmjs.org/ || echo "âš ï¸ whoami failed (Normal for OIDC)"

        # âœ…ã€æ­¥é©Ÿ Bã€‘ç™¼å¸ƒ (é–‹å•Ÿ Verbose æ¨¡å¼)
        - name: Publish to npm (Verbose)
          # --verbose æœƒå°å‡ºæ¯ä¸€å€‹ HTTP request çš„ç´°ç¯€
          run: npm publish --provenance --access public --verbose